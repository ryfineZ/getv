module.exports=[1382,(t,e,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={config:{baseUrl:"https://backend1.tioo.eu.org"},issues:"https://github.com/hostinger-bot/btch-downloader/issues"}},56475,(t,e,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={dev:"@prm2.0"}},42718,t=>{t.v({name:"btch-downloader",version:"6.0.25",description:"A lightweight TypeScript/JavaScript library for downloading media from social media platforms",main:"dist/index.js",browser:"dist/browser/index.js",unpkg:"dist/browser/index.min.js",jsdelivr:"dist/browser/index.min.js",types:"dist/index.d.ts",files:["dist","scripts/check-build.js","README.md","LICENSE","engine-requirements.js"],exports:{".":{types:"./dist/index.d.ts",browser:"./dist/browser/index.js",import:"./dist/index.js",require:"./dist/index.js"},"./Site":{types:"./dist/Defaults/site.d.ts",import:"./dist/Defaults/site.js",require:"./dist/Defaults/site.js"},"./Types":{types:"./dist/Types/index.d.ts",import:"./dist/Types/index.js",require:"./dist/Types/index.js"}},scripts:{build:"tsc && tsup","build:browser":"tsup",pub:"npm run build && npm publish --access public",test:"ts-node test/Test.ts",docs:"npx jsdoc -c jsdoc.conf.json",lint:"eslint . --cache","lint:fix":"eslint . --fix --cache","lint:debug":"eslint . --debug",preinstall:"node ./engine-requirements.js || true",postinstall:"node ./scripts/check-build.js",prepare:"npm run build"},keywords:["AIO","Instagram","TikTok","Facebook","YouTube","Twitter","X","MediaFire","Capcut","Gdrive","Pinterest","Douyin","Xiaohongshu","Rednote","SnackVideo","Cocofun","Spotify","YT-search","yts","SoundCloud","Threads","BOTCAHX","Tio","media-downloader","social-media","browser","typescript"],author:"Tio",license:"MIT",dependencies:{"btch-http":"^2.0.3","clean-jsdoc-theme":"^4.3.0",esbuild:"^0.27.0",install:"^0.13.0",jsdoc:"^4.0.5",lodash:"^4.17.21",rollup:"^4.52.5","set-value":"4.1.0","source-map":"^0.7.6","ts-node":"^10.9.2",tsup:"^8.5.0",typescript:"^5.9.3"},devDependencies:{"@eslint/js":"^9.39.1","@types/node":"^24.10.0","@typescript-eslint/eslint-plugin":"^8.47.0","@typescript-eslint/parser":"^8.47.0",eslint:"^9.39.1","eslint-plugin-import":"^2.32.0","eslint-plugin-unicorn":"^62.0.0",globals:"^16.5.0",jiti:"^2.6.1","typescript-eslint":"^8.47.0"},repository:{type:"git",url:"https://github.com/hostinger-bot/btch-downloader.git"},bugs:{url:"https://github.com/hostinger-bot/btch-downloader/issues"},homepage:"https://btch.foo.ng",directories:{doc:"docs",test:"test"},publishConfig:{access:"public",tag:"latest"},engines:{node:">=20.18.1"},overrides:{"set-value":"4.1.0"}})},43698,(t,e,r)=>{e.exports=t.x("node:https",()=>require("node:https"))},57764,(t,e,r)=>{e.exports=t.x("node:url",()=>require("node:url"))},85303,(t,e,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.HttpClient=void 0,r.HttpGet=i;let a=t.r(43698),o=t.r(57764);async function i(t,e,r,i,s){return new Promise((n,l)=>{try{let u=new o.URL(`${s}/${t}`);u.searchParams.append("url",e);let d={method:"GET",headers:{"Content-Type":"application/json","User-Agent":`btch/${r}`,"X-Client-Version":r},timeout:i},c=(0,a.request)(u,d,t=>{let e="";t.on("data",t=>{e+=t}),t.on("end",()=>{try{if(t.statusCode&&(t.statusCode<200||t.statusCode>=300))throw Error(`${t.statusCode} ${t.statusMessage||"Unknown"}`);let r=JSON.parse(e);n(r)}catch(t){l(Error(t instanceof Error?t.message:"Unknown error occurred"))}})});c.on("error",t=>{l(Error(t.message))}),c.on("timeout",()=>{c.destroy(),l(Error("Request timed out"))}),c.end()}catch(t){l(Error(t instanceof Error?t.message:"Unknown error occurred"))}})}class s extends Error{status;response;constructor(t,e,r){super(e),this.status=t,this.response=r,this.name="HttpError"}}r.HttpClient=class{config;constructor(t){this.config={timeout:6e4,defaultHeaders:{"Content-Type":"application/json","User-Agent":`btch/${t.version}`,"X-Client-Version":t.version},...t}}async get(t,e={},r={}){return new Promise((i,n)=>{try{let l=new o.URL(`${this.config.baseUrl}/${t}`);Object.entries(e).forEach(([t,e])=>{l.searchParams.append(t,e)});let u={...this.config.defaultHeaders,...r},d={method:"GET",headers:u,timeout:this.config.timeout},c=(0,a.request)(l,d,t=>{let e="",r=t.headers;t.on("data",t=>{e+=t}),t.on("end",()=>{try{if(!t.statusCode)throw Error("No status code received");let a={status:t.statusCode,statusText:t.statusMessage||"Unknown",data:e?JSON.parse(e):null,headers:r};if(t.statusCode<200||t.statusCode>=300)throw new s(t.statusCode,t.statusMessage||"Request failed",a);i(a)}catch(e){n(this.handleError(e,t.statusCode))}})});c.on("error",t=>{n(this.handleError(t))}),c.on("timeout",()=>{c.destroy(),n(this.handleError(Error("Request timed out")))}),c.end()}catch(t){n(this.handleError(t))}})}async post(t,e,r={}){return new Promise((i,n)=>{try{let l=new o.URL(`${this.config.baseUrl}/${t}`),u={...this.config.defaultHeaders,...r},d={method:"POST",headers:u,timeout:this.config.timeout},c=(0,a.request)(l,d,t=>{let e="",r=t.headers;t.on("data",t=>{e+=t}),t.on("end",()=>{try{if(!t.statusCode)throw Error("No status code received");let a={status:t.statusCode,statusText:t.statusMessage||"Unknown",data:e?JSON.parse(e):null,headers:r};if(t.statusCode<200||t.statusCode>=300)throw new s(t.statusCode,t.statusMessage||"Request failed",a);i(a)}catch(e){n(this.handleError(e,t.statusCode))}})});c.on("error",t=>{n(this.handleError(t))}),c.on("timeout",()=>{c.destroy(),n(this.handleError(Error("Request timed out")))}),e&&c.write(JSON.stringify(e)),c.end()}catch(t){n(this.handleError(t))}})}handleError(t,e){return t instanceof s?t:new s(e||500,t instanceof Error?t.message:"Unknown error occurred")}}},20083,(t,e,r)=>{"use strict";var a=t.e&&t.e.__createBinding||(Object.create?function(t,e,r,a){void 0===a&&(a=r);var o=Object.getOwnPropertyDescriptor(e,r);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,a,o)}:function(t,e,r,a){void 0===a&&(a=r),t[a]=e[r]}),o=t.e&&t.e.__exportStar||function(t,e){for(var r in t)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||a(e,t,r)};Object.defineProperty(r,"__esModule",{value:!0}),o(t.r(85303),r)},52081,(t,e,r)=>{"use strict";var a=t.e&&t.e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(r,"__esModule",{value:!0}),r.issues=r.developer=r.VERSION=void 0,r.fbdown=y,r.igdl=m,r.ttdl=p,r.twitter=f,r.youtube=g,r.mediafire=w,r.capcut=b,r.gdrive=k,r.pinterest=A,r.aio=v,r.xiaohongshu=x,r.douyin=T,r.snackvideo=E,r.cocofun=S,r.spotify=U,r.yts=$,r.soundcloud=D,r.threads=P;let o=a(t.r(1382)),i=a(t.r(56475)),s=a(t.r(42718)),n=t.r(20083),{config:l,issues:u}=o.default;r.issues=u;let d=i.default.dev;r.developer=d;let c=s.default.version;r.VERSION=c;let h=t=>({developer:d,status:!1,message:t instanceof Error?t.message:"Unknown error",note:`Please report issues to ${u}`});async function p(t){try{let e=await (0,n.HttpGet)("ttdl",t,c,6e4,l.baseUrl);return{developer:d,status:!0,title:e.title,title_audio:e.title_audio,thumbnail:e.thumbnail,video:e.video,audio:e.audio}}catch(t){return{...h(t),status:!1}}}async function m(t){try{let e=await (0,n.HttpGet)("igdl",t,c,6e4,l.baseUrl);if(!e||0===e.length)return{...h(Error("No results found")),status:!1};let r=[];for(let t of e)r.push({thumbnail:t.thumbnail,url:t.url});return{developer:d,status:!0,result:r}}catch(t){return{...h(t),status:!1}}}async function f(t){try{let e=await (0,n.HttpGet)("twitter",t,c,6e4,l.baseUrl);return{developer:d,status:!0,title:e.title,url:e.url}}catch(t){return{...h(t),status:!1}}}async function g(t){try{let e=await (0,n.HttpGet)("youtube",t,c,6e4,l.baseUrl);return{developer:d,status:!0,title:e.title,thumbnail:e.thumbnail,author:e.author,mp3:e.mp3,mp4:e.mp4}}catch(t){return{...h(t),status:!1}}}async function y(t){try{let e=await (0,n.HttpGet)("fbdown",t,c,6e4,l.baseUrl);return{developer:d,status:!0,Normal_video:e.Normal_video,HD:e.HD}}catch(t){return{...h(t),status:!1}}}async function w(t){try{let e=await (0,n.HttpGet)("mediafire",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function b(t){try{let e=await (0,n.HttpGet)("capcut",t,c,6e4,l.baseUrl);return{developer:d,status:!0,...e}}catch(t){return{...h(t),status:!1}}}async function v(t){try{let e=await (0,n.HttpGet)("aio",t,c,6e4,l.baseUrl);return{developer:d,status:!0,...e}}catch(t){return{...h(t),status:!1}}}async function k(t){try{let e=await (0,n.HttpGet)("gdrive",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function A(t){try{let e=await (0,n.HttpGet)("pinterest",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function x(t){try{let e=await (0,n.HttpGet)("rednote",t,c,6e4,l.baseUrl);if(!e||!e.noteId)return{...h(Error("No results found")),status:!1};return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function T(t){try{let e=await (0,n.HttpGet)("douyin",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function E(t){try{let e=await (0,n.HttpGet)("snackvideo",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function S(t){try{let e=await (0,n.HttpGet)("cocofun",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function U(t){try{let e=await (0,n.HttpGet)("spotify",t,c,6e4,l.baseUrl);return e?.res_data&&(delete e.message,"rapidapi"===e.res_data.server&&delete e.res_data.server,"success"===e.res_data.message&&delete e.res_data.message),{developer:d,status:!0,result:e.res_data}}catch(t){return{...h(t),status:!1}}}async function $(t){try{let e=await (0,n.HttpGet)("yts",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function D(t){try{let e=await (0,n.HttpGet)("soundcloud",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}async function P(t){try{let e=await (0,n.HttpGet)("threads",t,c,6e4,l.baseUrl);return{developer:d,status:!0,result:e}}catch(t){return{...h(t),status:!1}}}},66863,t=>{"use strict";var e=t.i(47909),r=t.i(74017),a=t.i(96250),o=t.i(59756),i=t.i(61916),s=t.i(74677),n=t.i(69741),l=t.i(16795),u=t.i(87718),d=t.i(95169),c=t.i(47587),h=t.i(66012),p=t.i(70101),m=t.i(26937),f=t.i(10372),g=t.i(93695);t.i(52474);var y=t.i(220),w=t.i(89171),b=t.i(22378);function v(t,e){try{let r=new URL(t);switch(e){case"youtube":{let t=r.searchParams.get("v");if(t)return t;let e=r.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);if(e)return e[1];let a=r.pathname.match(/\/embed\/([a-zA-Z0-9_-]+)/);if(a)return a[1];return null}case"tiktok":{let t=r.pathname.match(/\/video\/(\d+)/);return t?t[1]:null}case"twitter":{let t=r.pathname.match(/\/status\/(\d+)/);return t?t[1]:null}case"instagram":{let t=r.pathname.match(/\/(p|reel|reels)\/([a-zA-Z0-9_-]+)/);return t?t[2]:null}case"douyin":{let t=r.pathname.match(/\/(video|note)\/(\d+)/);return t?t[2]:null}case"xiaohongshu":{let t=r.pathname.match(/\/explore\/([a-zA-Z0-9]+)/);return t?t[1]:null}default:return null}}catch{return null}}class k{createFormat(t){return{id:t.id||`${this.platform}-${Date.now()}`,quality:t.quality||"unknown",format:t.format||"mp4",size:t.size,sizeText:t.size?this.formatFileSize(t.size):void 0,url:t.url||"",hasAudio:t.hasAudio??!0,hasVideo:t.hasVideo??!0,bitrate:t.bitrate,noWatermark:t.noWatermark}}createSuccess(t){return{success:!0,data:{...t,parsedAt:Date.now()}}}createError(t){return{success:!1,error:t}}formatFileSize(t){if(0===t)return"0 B";let e=Math.floor(Math.log(t)/Math.log(1024));return`${parseFloat((t/Math.pow(1024,e)).toFixed(2))} ${["B","KB","MB","GB"][e]}`}formatDuration(t){let e=Math.floor(t/3600),r=Math.floor(t%3600/60),a=Math.floor(t%60);return e>0?`${e}:${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${r}:${a.toString().padStart(2,"0")}`}async fetch(t,e){let r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8",...e?.headers||{}},a=await fetch(t,{...e,headers:r});if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);return a}async getRedirectUrl(t){return(await fetch(t,{method:"HEAD",redirect:"follow"})).url}}var A=t.i(52081),x=t.i(33405),T=t.i(24361);let E=(0,T.promisify)(x.exec),S=(0,T.promisify)(x.exec),U={youtube:new class extends k{platform="youtube";name="YouTube";async parse(t){try{let e=v(t,"youtube");if(!e)return this.createError("无法从 URL 中提取视频 ID");let r=await this.parseWithYoutubei(e);if(r)return this.createSuccess(r);let a=await this.parseWithBackup(e);if(a)return this.createSuccess(a);return this.createError("无法获取视频信息，请稍后重试")}catch(t){return this.createError(t instanceof Error?t.message:"解析失败")}}async parseWithYoutubei(t){try{let e=await this.fetch("https://www.youtube.com/youtubei/v1/player?key=AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:t,context:{client:{clientName:"WEB",clientVersion:"2.20241210.00.00",hl:"zh-CN",gl:"CN"}}})}),r=await e.json();if(!r.videoDetails||r.playabilityStatus?.status!=="OK")return null;let a=r.videoDetails,o=r.streamingData,i=[];if(o?.formats)for(let t of o.formats)t.url&&i.push(this.createFormat({id:t.itag?.toString()||`yt-${Date.now()}`,quality:t.qualityLabel||"unknown",format:"mp4",size:t.contentLength?parseInt(t.contentLength):void 0,url:t.url,hasAudio:!0,hasVideo:!0,bitrate:t.bitrate}));if(o?.adaptiveFormats){for(let t of o.adaptiveFormats)if(t.url&&t.mimeType?.includes("video")){let e=t.mimeType?.split(";")[0]||"",r=e.includes("avc")||e.includes("h264")?"h264":e.includes("vp9")?"vp9":e.includes("av01")?"av1":"other",a=t.qualityLabel;a||(a=t.width?`${t.width}p`:t.height?`${t.height}p`:"未知画质"),i.push(this.createFormat({id:t.itag?.toString()||`yt-${Date.now()}`,quality:a,format:e.split("/")[1]||"mp4",size:t.contentLength?parseInt(t.contentLength):void 0,url:t.url,hasAudio:!1,hasVideo:!0,bitrate:t.bitrate,codec:r,fps:t.fps}))}for(let t of o.adaptiveFormats)if(t.url&&t.mimeType?.includes("audio")){let e=t.mimeType?.split(";")[0]||"",r=t.bitrate||0,a=Math.round(r/1e3),o=a>=128?"高音质":a>=64?"中音质":"标准";i.push(this.createFormat({id:t.itag?.toString()||`audio-${Date.now()}`,quality:`${o} (${a}kbps)`,format:e.split("/")[1]||"mp4",size:t.contentLength?parseInt(t.contentLength):void 0,url:t.url,hasAudio:!0,hasVideo:!1,bitrate:t.bitrate}))}}i.sort((t,e)=>{let r=["2160p","1440p","1080p","720p","480p","360p","240p","144p"],a=r.indexOf(t.quality),o=r.indexOf(e.quality);if(a!==o)return a-o;let i={av1:0,vp9:1,h264:2,other:3},s=i[t.codec||"other"]??3,n=i[e.codec||"other"]??3;return s-n});let s=[];try{let e=new AbortController,r=setTimeout(()=>e.abort(),1e4),a=await globalThis.fetch("https://www.youtube.com/youtubei/v1/player?key=AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:t,context:{client:{clientName:"ANDROID",clientVersion:"19.09.37",androidSdkVersion:30,hl:"en",gl:"US"}}}),signal:e.signal});clearTimeout(r);let o=await a.json(),i=o.captions?.playerCaptionsTracklistRenderer,n=i?.captionTracks,l=i?.translationLanguages;if(console.log("[YouTube] captionTracks:",n?.length||0,", translationLanguages:",l?.length||0),Array.isArray(n)){for(let t of n){if(!t.baseUrl)continue;let e=t.baseUrl.includes("fmt=")?t.baseUrl.replace(/fmt=[^&]+/,"fmt=srv1"):`${t.baseUrl}&fmt=srv1`;s.push({lang:t.languageCode||"unknown",label:t.name?.simpleText||t.name?.runs?.[0]?.text||t.languageCode||"未知",url:e,format:"srt",isAutoGenerated:"asr"===t.kind})}if(Array.isArray(l)&&n.length>0){let t=n.find(t=>"asr"!==t.kind)||n[0];if(t?.baseUrl){let e=new Set(s.map(t=>t.lang));for(let r of l){let a=r.languageCode;if(!a||e.has(a))continue;let o=t.baseUrl.includes("fmt=")?t.baseUrl.replace(/fmt=[^&]+/,"fmt=srv1")+`&tlang=${a}`:`${t.baseUrl}&fmt=srv1&tlang=${a}`;s.push({lang:a,label:r.languageName?.simpleText||r.languageName?.runs?.[0]?.text||a,url:o,format:"srt",isAutoGenerated:!0})}}}}}catch(t){console.log("[YouTube] 字幕获取失败（不影响视频解析）:",t instanceof Error?t.message:t)}return console.log("[YouTube] 最终字幕数量:",s.length),{id:t,platform:"youtube",title:a.title||"无标题",description:a.shortDescription,thumbnail:a.thumbnail?.thumbnails?.pop()?.url||`https://i.ytimg.com/vi/${t}/maxresdefault.jpg`,duration:parseInt(a.lengthSeconds)||0,durationText:this.formatDuration(parseInt(a.lengthSeconds)||0),author:a.author,formats:i,subtitles:s.length>0?s:void 0,originalUrl:`https://www.youtube.com/watch?v=${t}`,parsedAt:Date.now()}}catch{return null}}async parseWithBackup(t){try{let e=await this.fetch("https://api.cobalt.tools/api/json",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({url:`https://www.youtube.com/watch?v=${t}`,vCodec:"h264",vQuality:"1080",aFormat:"mp3"})}),r=await e.json();if("error"===r.status)return null;let a=[];if(("stream"===r.status||"redirect"===r.status)&&a.push(this.createFormat({id:`cobalt-${Date.now()}`,quality:"best",format:"mp4",url:r.url,hasAudio:!0,hasVideo:!0})),"picker"===r.status&&Array.isArray(r.picker))for(let t of r.picker)a.push(this.createFormat({id:`cobalt-picker-${Date.now()}`,quality:t.quality||"unknown",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}));if(0===a.length)return null;return{id:t,platform:"youtube",title:r.filename?.replace(/\.[^/.]+$/,"")||"YouTube 视频",thumbnail:`https://i.ytimg.com/vi/${t}/maxresdefault.jpg`,duration:0,formats:a,originalUrl:`https://www.youtube.com/watch?v=${t}`,parsedAt:Date.now()}}catch{return null}}},tiktok:new class extends k{platform="tiktok";name="TikTok";async parse(t){try{let e=await this.getRealUrl(t),r=v(e,"tiktok");if(!r)return this.createError("无法从 URL 中提取视频 ID");let a=await this.parseWithTikwm(r)||await this.parseWithTikmate(r)||await this.parseWithCobalt(t);if(a)return this.createSuccess(a);return this.createError("无法获取视频信息，请稍后重试")}catch(t){return this.createError(t instanceof Error?t.message:"解析失败")}}async getRealUrl(t){try{if(t.includes("vm.tiktok.com")||t.includes("vt.tiktok.com"))return(await this.fetch(t,{method:"HEAD",redirect:"follow"})).url;return t}catch{return t}}async parseWithTikwm(t){try{let e=await this.fetch(`https://www.tikwm.com/api/?url=https://www.tiktok.com/video/${t}`,{headers:{Accept:"application/json"}}),r=await e.json();if(0!==r.code||!r.data)return null;let a=r.data,o=[];if(a.play&&o.push(this.createFormat({id:`tiktok-hd-${t}`,quality:"HD (无水印)",format:"mp4",url:a.play,hasAudio:!0,hasVideo:!0,noWatermark:!0})),a.wmplay&&o.push(this.createFormat({id:`tiktok-wm-${t}`,quality:"HD (有水印)",format:"mp4",url:a.wmplay,hasAudio:!0,hasVideo:!0,noWatermark:!1})),a.music&&o.push(this.createFormat({id:`tiktok-audio-${t}`,quality:"音频",format:"mp3",url:a.music,hasAudio:!0,hasVideo:!1})),0===o.length)return null;return{id:t,platform:"tiktok",title:a.title||"TikTok 视频",description:a.desc||a.title,thumbnail:a.cover||a.origin_cover,duration:a.duration||0,durationText:this.formatDuration(a.duration||0),author:a.author?.nickname||a.author?.unique_id,authorAvatar:a.author?.avatar,formats:o,originalUrl:`https://www.tiktok.com/video/${t}`,parsedAt:Date.now()}}catch{return null}}async parseWithTikmate(t){try{let e=await this.fetch(`https://api.tikmate.app/api/lookup?url=https://www.tiktok.com/video/${t}`,{headers:{Accept:"application/json"}}),r=await e.json();if(!r.success||!r.video)return null;let a=[];if(r.video?.url&&a.push(this.createFormat({id:`tikmate-${t}`,quality:"HD (无水印)",format:"mp4",url:r.video.url,hasAudio:!0,hasVideo:!0,noWatermark:!0})),r.video?.url_no_wm&&a.push(this.createFormat({id:`tikmate-nwm-${t}`,quality:"无水印",format:"mp4",url:r.video.url_no_wm,hasAudio:!0,hasVideo:!0,noWatermark:!0})),0===a.length)return null;return{id:t,platform:"tiktok",title:r.video.title||"TikTok 视频",thumbnail:r.video.cover,duration:r.video.duration||0,durationText:this.formatDuration(r.video.duration||0),author:r.video.author?.nickname,formats:a,originalUrl:`https://www.tiktok.com/video/${t}`,parsedAt:Date.now()}}catch{return null}}async parseWithCobalt(t){try{let e=await this.fetch("https://api.cobalt.tools/api/json",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({url:t,aFormat:"mp3"})}),r=await e.json();if("error"===r.status)return null;let a=[];if(("stream"===r.status||"redirect"===r.status)&&a.push(this.createFormat({id:`cobalt-tiktok-${Date.now()}`,quality:"最佳",format:"mp4",url:r.url,hasAudio:!0,hasVideo:!0,noWatermark:!0})),0===a.length)return null;return{id:t.split("/video/")[1]?.split("?")[0]||"",platform:"tiktok",title:r.filename?.replace(/\.[^/.]+$/,"")||"TikTok 视频",thumbnail:"",duration:0,formats:a,originalUrl:t,parsedAt:Date.now()}}catch{return null}}},twitter:new class extends k{platform="twitter";name="Twitter/X";async parse(t){try{let e=this.extractTweetId(t);if(!e)return this.createError("无法从 URL 中提取推文 ID");console.log("[Twitter] Tweet ID:",e);let r=`https://api.fxtwitter.com/status/${e}`,a=await this.fetch(r),o=await a.json();if(200!==o.code||!o.tweet)return this.createError("无法获取推文信息，可能是私密推文或已删除");let i=o.tweet,s=i.text||"Twitter 视频",n=i.author?.name||"",l=i.author?.avatar_url||"",u=i.media?.videos?.[0]?.thumbnail_url||i.media?.all?.[0]?.thumbnail_url||"",d=i.media?.videos?.[0]?.duration||0,c=[];for(let t of i.media?.videos||[]){if(t.formats&&Array.isArray(t.formats))for(let r=0;r<t.formats.length;r++){let a=t.formats[r];if("mp4"!==a.container&&!a.url.includes(".mp4"))continue;let o=a.url.match(/\/(\d+)x(\d+)\//);o?parseInt(o[1]):t.width;let i=o?parseInt(o[2]):t.height||0,s=i>=1080?"超清 1080p":i>=720?"高清 720p":i>=480?"标清 480p":i>=360?"流畅 360p":`画质 ${i}p`;c.some(t=>t.url===a.url)||c.push(this.createFormat({id:`twitter-${e}-${c.length}`,quality:`${s}`,format:"mp4",url:a.url,size:a.bitrate?Math.round(d*a.bitrate/8):void 0,hasAudio:!0,hasVideo:!0,bitrate:a.bitrate}))}if(t.variants&&Array.isArray(t.variants)){for(let r of t.variants)if("video/mp4"===r.content_type&&r.url){if(c.some(t=>t.url===r.url))continue;let t=r.url.match(/\/(\d+)x(\d+)\//),a=t?parseInt(t[2]):0,o=a>=1080?"超清 1080p":a>=720?"高清 720p":a>=480?"标清 480p":a>=360?"流畅 360p":`画质 ${a||"?"}p`;c.push(this.createFormat({id:`twitter-${e}-${c.length}`,quality:o,format:"mp4",url:r.url,hasAudio:!0,hasVideo:!0,bitrate:r.bitrate}))}}}if(0===c.length&&i.media?.videos?.[0]?.url&&c.push(this.createFormat({id:`twitter-${e}`,quality:"原画",format:"mp4",url:i.media.videos[0].url,hasAudio:!0,hasVideo:!0})),0===c.length)return this.createError("该推文不包含视频，可能只是文字或图片");return c.sort((t,e)=>(e.bitrate||0)-(t.bitrate||0)),this.createSuccess({id:e,platform:"twitter",title:s,description:s,thumbnail:u,duration:d,durationText:this.formatDuration(d),author:n,authorAvatar:l,formats:c,originalUrl:t,parsedAt:Date.now()})}catch(t){return console.error("[Twitter] Parse error:",t),this.createError(t instanceof Error?t.message:"解析失败")}}extractTweetId(t){let e=t.match(/\/status\/(\d+)/);return e?e[1]:null}},instagram:new class extends k{platform="instagram";name="Instagram";async parse(t){try{let e=this.extractPostId(t),r=await this.fetch("https://api.cobalt.tools/api/json",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({url:t,aFormat:"mp3"})}),a=await r.json();if("error"===a.status)return this.createError("无法解析此 Instagram 内容");let o=await this.getThumbnail(t,e),i=[];if(a.url?i.push(this.createFormat({id:`ig-${Date.now()}`,quality:"原画",format:"mp4",url:a.url,hasAudio:!0,hasVideo:!0})):a.picker&&Array.isArray(a.picker)&&a.picker.forEach((t,e)=>{"video"===t.type&&i.push(this.createFormat({id:`ig-${e}`,quality:`视频 ${e+1}`,format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}))}),0===i.length)return this.createError("未找到视频内容，可能是纯图片帖子");return this.createSuccess({id:e||`ig-${Date.now()}`,platform:"instagram",title:a.filename?.replace(/\.[^/.]+$/,"")||"Instagram 视频",thumbnail:o,duration:0,formats:i,originalUrl:t,parsedAt:Date.now()})}catch(t){return this.createError(t instanceof Error?t.message:"解析失败")}}extractPostId(t){let e=t.match(/\/(p|reel|reels)\/([^/?]+)/);return e?e[2]:""}async getThumbnail(t,e){try{encodeURIComponent(t);let r=`https://www.instagram.com/p/${e}/media/?size=l`,a=await this.fetch(r,{method:"HEAD",redirect:"follow"});if(a.url&&a.url.includes("cdninstagram"))return a.url;return`https://www.instagram.com/p/${e}/media/?size=l`}catch{return""}}},douyin:new class extends k{platform="douyin";name="抖音";async parse(t){try{let e=await this.resolveShortUrl(t);console.log("[Douyin] Real URL:",e);let r=this.extractVideoId(e);if(!r)return this.createError("无法从 URL 中提取视频 ID");for(let a of(console.log("[Douyin] Video ID:",r),[()=>this.parseWithTikVideo(e),()=>this.parseWithDouyinWtf(r),()=>this.parseWithSnapTik(t),()=>this.parseWithTikSave(t),()=>this.parseWithSSSTik(t)]))try{let t=await a();if(t)return this.createSuccess(t)}catch(t){console.log("[Douyin] Method failed:",t)}return this.createError("无法获取视频信息，可能需要登录或视频已删除")}catch(t){return console.error("[Douyin] Parse error:",t),this.createError(t instanceof Error?t.message:"解析失败")}}async resolveShortUrl(t){try{if(t.includes("v.douyin.com")||t.includes("vm.douyin.com"))return(await this.fetch(t,{method:"GET",redirect:"follow",headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15"}})).url;return t}catch{return t}}extractVideoId(t){let e=t.match(/\/(video|note)\/(\d+)/);if(e)return e[2];let r=t.match(/modId=(\d+)/);return r?r[1]:null}async parseWithTikVideo(t){try{let e,r=new URLSearchParams({q:t,lang:"en",cftoken:""}),a=await this.fetch("https://tikvideo.app/api/ajaxSearch",{method:"POST",headers:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest",Referer:"https://tikvideo.app/en/download-douyin-video"},body:r.toString()}),o=await a.json();if("ok"!==o.status||!o.data)return null;let i=o.data,s=[],n=i.match(/<h3>([^<]+)<\/h3>/),l=n?n[1].trim():"抖音视频",u=i.match(/<p>(\d+:\d+)<\/p>/),d=u?u[1]:"0:00",c=this.parseDuration(d),h=i.match(/<img src="([^"]+)"/),p=h?h[1].replace(/&amp;/g,"&"):"",m=/<a[^>]*href="([^"]*)"[^>]*class="[^"]*tik-button-dl[^"]*"[^>]*>([\s\S]*?)<\/a>/gi;for(;null!==(e=m.exec(i));){let t=e[1].replace(/&amp;/g,"&"),r=e[2].replace(/<[^>]*>/g,"").trim();if(!(r.toLowerCase().includes("mp3")||r.toLowerCase().includes("profile"))){s.push(this.createFormat({id:"douyin-original",quality:"原画",format:"mp4",url:t,hasAudio:!0,hasVideo:!0}));break}}if(0===s.length)return null;return{id:this.extractVideoId(t)||Date.now().toString(),platform:"douyin",title:l,description:"",thumbnail:p,duration:c,durationText:this.formatDuration(c),author:"",authorAvatar:"",formats:s,originalUrl:t,parsedAt:Date.now()}}catch(t){return console.error("[Douyin] TikVideo error:",t),null}}parseDuration(t){let e=t.split(":").map(Number);return 2===e.length?60*e[0]+e[1]:3===e.length?3600*e[0]+60*e[1]+e[2]:0}async parseWithDouyinWtf(t){try{let e=await this.fetch(`https://api.douyin.wtf/api?url=https://www.douyin.com/video/${t}`,{headers:{Accept:"application/json"}}),r=await e.json();if(r.url||r.video){let e=r.url||r.video;return{id:t,platform:"douyin",title:r.title||"抖音视频",thumbnail:r.cover||r.thumbnail||"",duration:0,formats:[this.createFormat({id:`douyin-${t}`,quality:"原画",format:"mp4",url:e,hasAudio:!0,hasVideo:!0})],originalUrl:`https://www.douyin.com/video/${t}`,parsedAt:Date.now()}}return null}catch{return null}}async parseWithSnapTik(t){try{let e=await this.fetch("https://snaptik.app/abc2.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"},body:`url=${encodeURIComponent(t)}`}),r=(await e.text()).match(/https?:\/\/[^\s"'<>]+\.mp4[^\s"'<>]*/);if(r)return{id:this.extractVideoId(t)||Date.now().toString(),platform:"douyin",title:"抖音视频",thumbnail:"",duration:0,formats:[this.createFormat({id:`douyin-snaptik-${Date.now()}`,quality:"原画",format:"mp4",url:r[0].replace(/\\/g,""),hasAudio:!0,hasVideo:!0})],originalUrl:t,parsedAt:Date.now()};return null}catch{return null}}async parseWithTikSave(t){try{let e=await this.fetch("https://tiksave.io/api/ajaxSearch",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`q=${encodeURIComponent(t)}&lang=zh`}),r=(await e.text()).match(/https?:\/\/[^\s"'<>]+\.mp4[^\s"'<>]*/);if(r)return{id:this.extractVideoId(t)||Date.now().toString(),platform:"douyin",title:"抖音视频",thumbnail:"",duration:0,formats:[this.createFormat({id:`douyin-tiksave-${Date.now()}`,quality:"原画",format:"mp4",url:r[0].replace(/\\/g,"").replace(/&amp;/g,"&"),hasAudio:!0,hasVideo:!0})],originalUrl:t,parsedAt:Date.now()};return null}catch{return null}}async parseWithSSSTik(t){try{let e=await this.fetch("https://ssstik.io/abc",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"},body:`url=${encodeURIComponent(t)}`}),r=(await e.text()).match(/href="(https?:\/\/[^"]+\.mp4[^"]*)"/);if(r)return{id:this.extractVideoId(t)||Date.now().toString(),platform:"douyin",title:"抖音视频",thumbnail:"",duration:0,formats:[this.createFormat({id:`douyin-ssstik-${Date.now()}`,quality:"原画",format:"mp4",url:r[1].replace(/&amp;/g,"&"),hasAudio:!0,hasVideo:!0})],originalUrl:t,parsedAt:Date.now()};return null}catch{return null}}},xiaohongshu:new class extends k{platform="xiaohongshu";name="小红书";async parse(t){try{let e=await this.resolveShortUrl(t);console.log("[Xiaohongshu] Real URL:",e);let r=this.extractNoteId(e);if(!r)return this.createError("无法从 URL 中提取笔记 ID");console.log("[Xiaohongshu] Note ID:",r);let a=await (0,A.xiaohongshu)(e);if(!a||!a.status||!a.result){if(a?.message?.includes("No results"))return this.createError("该笔记可能是图片笔记或已删除，请确认链接是否为视频笔记");return this.createError(a?.message||"解析失败，请检查链接是否正确")}let o=a.result,i=o.title||o.nickname||o.desc?.substring(0,100)||"小红书笔记",s=o.desc||"",n=o.images?.[0]||o.cover||"",l=0;if(o.duration){let t=o.duration.split(":").map(Number);2===t.length?l=60*t[0]+t[1]:3===t.length&&(l=3600*t[0]+60*t[1]+t[2])}let u=[];if(o.downloads&&Array.isArray(o.downloads))for(let t=0;t<o.downloads.length;t++){let e=o.downloads[t];e.url&&u.push(this.createFormat({id:`xhs-${r}-${t}`,quality:e.quality||`画质 ${t+1}`,format:"mp4",url:e.url,hasAudio:!0,hasVideo:!0}))}if(o.video){let t="string"==typeof o.video?o.video:o.video.url;t&&0===u.length&&u.push(this.createFormat({id:`xhs-${r}`,quality:"原画",format:"mp4",url:t,hasAudio:!0,hasVideo:!0}))}if(o.images&&o.images.length>0&&0===u.length)return this.createError(`这是一个图片笔记，共 ${o.images.length} 张图片，暂不支持下载图片笔记`);if(0===u.length)return this.createError("未找到视频下载链接，该笔记可能是图片类型或需要登录");return this.createSuccess({id:r,platform:"xiaohongshu",title:i,description:s,thumbnail:n,duration:l,durationText:this.formatDuration(l),author:o.nickname||"",authorAvatar:"",formats:u,originalUrl:e,parsedAt:Date.now()})}catch(t){return console.error("[Xiaohongshu] Parse error:",t),this.createError(t instanceof Error?t.message:"解析失败")}}async resolveShortUrl(t){try{if(t.includes("xhslink.com")||t.includes("www.xhslink.com")){console.log("[Xiaohongshu] Resolving short URL:",t);let e=await this.fetch(t,{method:"GET",redirect:"follow",headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 MicroMessenger/8.0.0"}});return console.log("[Xiaohongshu] Resolved to:",e.url),e.url}return t}catch(e){return console.error("[Xiaohongshu] resolveShortUrl error:",e),t}}extractNoteId(t){let e=t.match(/\/explore\/([a-zA-Z0-9]+)/);if(e)return e[1];let r=t.match(/\/discovery\/item\/([a-zA-Z0-9]+)/);if(r)return r[1];try{let e=new URL(t),r=e.searchParams.get("noteId")||e.searchParams.get("note_id");if(r)return r}catch{}return null}},wechat:new class extends k{platform="wechat";name="视频号";async parse(t){return t.includes("channels.weixin.qq.com")||t.includes("finder.video.qq.com")?this.parseDirectUrl(t):this.createError("视频号视频需要手动获取链接。请使用抓包工具（如 Stream 抓包）获取视频的真实地址，然后粘贴到这里。")}async parseDirectUrl(t){try{let e=await this.fetch(t,{method:"HEAD"});if(!(e.headers.get("content-type")||"").includes("video"))return this.createError("这不是一个有效的视频链接");let r=e.headers.get("content-length"),a=r?parseInt(r):void 0;return this.createSuccess({id:`wechat-${Date.now()}`,platform:"wechat",title:"微信视频号视频",thumbnail:"",duration:0,formats:[{id:`wechat-${Date.now()}`,quality:"original",format:"mp4",url:t,size:a,sizeText:a?this.formatFileSize(a):void 0,hasAudio:!0,hasVideo:!0}],originalUrl:t,parsedAt:Date.now(),expiresIn:86400})}catch(t){return this.createError(t instanceof Error?t.message:"解析失败")}}},pornhub:new class extends k{platform="pornhub";name="Adult Video";async parse(t){try{console.log("[Adult] Parsing:",t);let{stdout:e}=await S(`python3 -m yt_dlp --dump-json --no-warnings --no-check-certificate "${t}"`,{maxBuffer:0xa00000,timeout:12e4}),r=JSON.parse(e),a=r.id||t.match(/viewkey=([a-f0-9]+)/)?.[1]||Date.now().toString(),o=[],i=new Set;if(r.formats&&Array.isArray(r.formats))for(let t of r.formats){if("m3u8_native"===t.protocol||"m3u8"===t.protocol||!t.url||"none"===t.video_ext&&"none"===t.audio_ext)continue;let e=t.format_id||`${t.height}p`,a=`${e}-${t.ext}`;if(i.has(a))continue;i.add(a);let s=t.filesize||t.filesize_approx;!s&&t.tbr&&r.duration&&(s=Math.round(1e3*t.tbr*r.duration/8)),o.push(this.createFormat({id:t.format_id||`fmt-${Date.now()}`,quality:t.height?`${t.height}p`:e,format:t.ext||"mp4",size:s,url:t.url,hasAudio:"none"!==t.acodec&&"none"!==t.audio_ext,hasVideo:"none"!==t.vcodec&&"none"!==t.video_ext,bitrate:t.tbr?Math.round(1e3*t.tbr):void 0}))}return 0===o.length&&r.url&&o.push(this.createFormat({id:"default",quality:"best",format:"mp4",url:r.url,hasAudio:!0,hasVideo:!0})),o.sort((t,e)=>{let r,a;return r=e.quality,(parseInt(r)||0)-(a=t.quality,parseInt(a)||0)}),this.createSuccess({id:a,platform:"pornhub",title:r.title||r.fulltitle||"Video",description:r.description||"",thumbnail:r.thumbnail||r.thumbnails?.[0]?.url||"",duration:r.duration||0,durationText:this.formatDuration(r.duration||0),author:r.uploader||r.channel||"",authorAvatar:"",formats:o.slice(0,10),originalUrl:t,parsedAt:Date.now()})}catch(e){console.error("[Adult] Error:",e);let t=e instanceof Error?e.message:"解析失败";if(t.includes("Piracy")||t.includes("no longer supported"))return this.createError("yt-dlp 已停止支持该站点。请安装浏览器插件，在视频页面上直接嗅探视频链接下载");if(t.includes("Unsupported URL"))return this.createError("该站点暂不支持服务端解析。请安装浏览器插件，在视频页面上直接嗅探视频链接下载");if(t.includes("Video unavailable")||t.includes("not available"))return this.createError("视频不可用或已被删除");if(t.includes("Private video"))return this.createError("这是私密视频，无法下载");if(t.includes("age"))return this.createError("需要验证年龄才能访问此视频");if(t.includes("HTTP Error 403")||t.includes("Cloudflare"))return this.createError("该站点有 Cloudflare 保护，服务端无法访问。请安装浏览器插件，在视频页面上直接嗅探视频链接下载");return this.createError("解析失败，请安装浏览器插件在视频页面上嗅探下载")}}}},$=new class extends k{platform="youtube";name="btch-downloader";async parse(t){try{let e;console.log("[Btch] Parsing:",t);let r=this.detectPlatform(t);switch(r){case"tiktok":e=await (0,A.ttdl)(t);break;case"douyin":e=await (0,A.douyin)(t);break;case"instagram":e=await (0,A.igdl)(t);break;case"youtube":e=await (0,A.youtube)(t);break;case"twitter":e=await (0,A.twitter)(t);break;case"xiaohongshu":e=await (0,A.xiaohongshu)(t);break;default:e=await (0,A.aio)(t)}if(!e||!e.url&&!e.video&&!e.data&&!e.result)return this.createError("无法获取视频信息");let a="",o="",i="",s="",n=0,l=[];if(e.url?a=e.url:e.video?a=e.video:e.data&&e.data.url&&(a=e.data.url),e.result&&e.result.downloads){let r=e.result;if(o=r.images?.[0]||"",i=r.title||r.nickname||"小红书笔记",s=r.nickname||"",r.duration){let t=r.duration.split(":").map(Number);2===t.length&&(n=60*t[0]+t[1])}if(r.downloads&&Array.isArray(r.downloads))for(let t of r.downloads)t.url&&l.push(this.createFormat({id:t.quality||`fmt-${Date.now()}`,quality:t.quality||"原画",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}));if(l.length>0)return this.createSuccess({id:r.noteId||Date.now().toString(),platform:"xiaohongshu",title:i,description:r.desc||"",thumbnail:o,duration:n,durationText:this.formatDuration(n),author:s,authorAvatar:"",formats:l,originalUrl:t,parsedAt:Date.now()})}if(e.medias&&Array.isArray(e.medias)){let t=e.medias.filter(t=>"video"===t.type&&t.url);if(t.length>0){let e=t.find(t=>t.audio);a=e?.url||t[0].url}}if(o=e.thumbnail||e.cover||e.image||"",i=e.title||e.caption||"未知标题",s=e.author?.nickname||e.author||"",n=e.duration||0,!a)return this.createError("无法获取视频下载链接");if(e.medias&&Array.isArray(e.medias))for(let t of e.medias)"video"===t.type&&t.url&&l.push(this.createFormat({id:t.quality||`fmt-${Date.now()}`,quality:t.quality||"原画",format:t.extension||"mp4",size:t.size,url:t.url,hasAudio:!1!==t.audio,hasVideo:!0}));return 0===l.length&&l.push(this.createFormat({id:"default",quality:"原画",format:"mp4",url:a,hasAudio:!0,hasVideo:!0})),this.createSuccess({id:e.id||Date.now().toString(),platform:r,title:i,description:e.description||"",thumbnail:o,duration:n,durationText:this.formatDuration(n),author:s,authorAvatar:e.author?.avatar||"",formats:l,originalUrl:t,parsedAt:Date.now()})}catch(e){console.error("[Btch] Error:",e);let t=e instanceof Error?e.message:"解析失败";if(t.includes("Invalid URL")||t.includes("not supported"))return this.createError("不支持此链接格式");if(t.includes("private")||t.includes("not found"))return this.createError("视频不可用或为私密视频");return this.createError("解析失败，请检查链接是否正确")}}detectPlatform(t){return t.includes("youtube.com")||t.includes("youtu.be")?"youtube":t.includes("tiktok.com")?"tiktok":t.includes("twitter.com")||t.includes("x.com")?"twitter":t.includes("instagram.com")?"instagram":t.includes("douyin.com")?"douyin":t.includes("xiaohongshu.com")||t.includes("xhslink.com")?"xiaohongshu":"unknown"}},D=new class extends k{platform="youtube";name="btch-edge";async parse(t){try{console.log("[BtchEdge] Parsing:",t);let e=this.detectPlatform(t),r="";switch(e){case"xiaohongshu":r="rednote";break;case"douyin":r="douyin";break;case"tiktok":r="ttdl";break;case"instagram":r="igdl";break;case"twitter":r="twitter";break;case"youtube":r="youtube";break;default:r="aio"}let a=`https://backend1.tioo.eu.org/${r}?url=${encodeURIComponent(t)}`;console.log("[BtchEdge] API URL:",a);let o=await fetch(a,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"}});if(!o.ok)return this.createError(`API 请求失败: HTTP ${o.status}`);let i=await o.json();if(console.log("[BtchEdge] Response:",JSON.stringify(i).substring(0,200)),i.noteId||i.result?.noteId)return this.parseXiaohongshu(i,t);if(i.result?.video||i.result?.downloads)return this.parseDouyin(i,t);if(i.video&&Array.isArray(i.video))return this.parseTiktok(i,t);if(i.mp4||i.mp3)return this.parseYouTube(i,t);if(Array.isArray(i)&&i[0]?.url)return this.parseInstagram(i,t);if(i.url)return this.parseTwitter(i,t);return this.createError("无法解析 API 响应")}catch(t){return console.error("[BtchEdge] Error:",t),this.createError(t instanceof Error?t.message:"解析失败")}}parseXiaohongshu(t,e){let r=t.result||t,a=[];if(r.downloads&&Array.isArray(r.downloads))for(let t of r.downloads)t.url&&a.push(this.createFormat({id:t.quality||"default",quality:t.quality||"原画",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}));if(0===a.length)return this.createError("未找到视频下载链接");let o=0;if(r.duration){let t=r.duration.split(":").map(Number);2===t.length&&(o=60*t[0]+t[1])}return this.createSuccess({id:r.noteId||Date.now().toString(),platform:"xiaohongshu",title:r.title||r.nickname||"小红书笔记",description:r.desc||"",thumbnail:r.images?.[0]||"",duration:o,durationText:this.formatDuration(o),author:r.nickname||"",authorAvatar:"",formats:a,originalUrl:e,parsedAt:Date.now()})}parseDouyin(t,e){let r=t.result||t,a=[],o=new Set;if(r.downloads&&Array.isArray(r.downloads)){for(let t of r.downloads)if(t.url&&!o.has(t.url)){o.add(t.url),a.push(this.createFormat({id:t.quality||"default",quality:"原画",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}));break}}if(0===a.length&&r.video&&a.push(this.createFormat({id:"default",quality:"原画",format:"mp4",url:r.video,hasAudio:!0,hasVideo:!0})),0===a.length&&r.links&&Array.isArray(r.links)){let t=r.links[0];t?.url&&a.push(this.createFormat({id:"default",quality:"原画",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0}))}return 0===a.length?this.createError("未找到视频下载链接"):this.createSuccess({id:r.noteId||r.videoId||Date.now().toString(),platform:"douyin",title:r.title||r.desc?.substring(0,100)||"抖音视频",description:r.desc||"",thumbnail:r.cover||r.images?.[0]||"",duration:0,durationText:"",author:r.nickname||r.author||"",authorAvatar:"",formats:a,originalUrl:e,parsedAt:Date.now()})}parseTiktok(t,e){let r=[];if(t.video&&Array.isArray(t.video))for(let e=0;e<t.video.length;e++){let a=t.video[e];r.push(this.createFormat({id:`video-${e}`,quality:a.quality||`画质 ${e+1}`,format:"mp4",url:a.url||a,hasAudio:!0,hasVideo:!0}))}return 0===r.length?this.createError("未找到视频下载链接"):this.createSuccess({id:Date.now().toString(),platform:"tiktok",title:t.title||"TikTok Video",description:"",thumbnail:t.thumbnail||"",duration:0,durationText:"",author:"",authorAvatar:"",formats:r,originalUrl:e,parsedAt:Date.now()})}parseYouTube(t,e){let r=[];return(t.mp4&&r.push(this.createFormat({id:"mp4",quality:"MP4",format:"mp4",url:t.mp4,hasAudio:!0,hasVideo:!0})),t.mp3&&r.push(this.createFormat({id:"mp3",quality:"MP3",format:"mp3",url:t.mp3,hasAudio:!0,hasVideo:!1})),0===r.length)?this.createError("未找到视频下载链接"):this.createSuccess({id:Date.now().toString(),platform:"youtube",title:t.title||"YouTube Video",description:"",thumbnail:t.thumbnail||"",duration:0,durationText:"",author:t.author||"",authorAvatar:"",formats:r,originalUrl:e,parsedAt:Date.now()})}parseInstagram(t,e){let r=[];for(let e=0;e<t.length;e++){let a=t[e];a.url&&r.push(this.createFormat({id:`ig-${e}`,quality:`视频 ${e+1}`,format:"mp4",url:a.url,hasAudio:!0,hasVideo:!0}))}return 0===r.length?this.createError("未找到视频下载链接"):this.createSuccess({id:Date.now().toString(),platform:"instagram",title:"Instagram Media",description:"",thumbnail:t[0]?.thumbnail||"",duration:0,durationText:"",author:"",authorAvatar:"",formats:r,originalUrl:e,parsedAt:Date.now()})}parseTwitter(t,e){return this.createSuccess({id:Date.now().toString(),platform:"twitter",title:t.title||"Twitter Video",description:"",thumbnail:"",duration:0,durationText:"",author:"",authorAvatar:"",formats:[this.createFormat({id:"default",quality:"原画",format:"mp4",url:t.url,hasAudio:!0,hasVideo:!0})],originalUrl:e,parsedAt:Date.now()})}detectPlatform(t){return t.includes("xiaohongshu.com")||t.includes("xhslink.com")?"xiaohongshu":t.includes("douyin.com")?"douyin":t.includes("tiktok.com")?"tiktok":t.includes("instagram.com")?"instagram":t.includes("twitter.com")||t.includes("x.com")?"twitter":t.includes("youtube.com")||t.includes("youtu.be")?"youtube":"unknown"}},P=new class extends k{platform="other";name="yt-dlp";async parse(t){try{let{stdout:e}=await E(`python3 -m yt_dlp --dump-json --no-warnings "${t}"`,{maxBuffer:0xa00000,timeout:3e4}),r=JSON.parse(e),a=[],o=new Set;if(r.formats&&Array.isArray(r.formats))for(let t of r.formats){if(!t.url||"none"===t.vcodec&&"none"===t.acodec)continue;let e=t.format_note||t.height?`${t.height}p`:"unknown",r=`${e}-${t.ext}`;o.has(r)||(o.add(r),a.push(this.createFormat({id:t.format_id||`fmt-${Date.now()}`,quality:e,format:t.ext||"mp4",size:t.filesize||t.filesize_approx,url:t.url,hasAudio:"none"!==t.acodec,hasVideo:"none"!==t.vcodec,bitrate:t.tbr||t.abr||t.vbr})))}0===a.length&&r.url&&a.push(this.createFormat({id:"default",quality:"best",format:"mp4",url:r.url,hasAudio:!0,hasVideo:!0})),a.sort((t,e)=>{let r=["2160p","1440p","1080p","720p","480p","360p","240p","144p"],a=r.indexOf(t.quality),o=r.indexOf(e.quality);return a-o});let i=[];for(let t of[{data:r.subtitles,isAuto:!1},{data:r.automatic_captions,isAuto:!0}])if(t.data&&"object"==typeof t.data)for(let[e,r]of Object.entries(t.data)){if(!Array.isArray(r)||0===r.length)continue;let a=r.find(t=>"vtt"===t.ext)||r.find(t=>"srt"===t.ext)||r[0];a?.url&&i.push({lang:e,label:a.name||e,url:a.url,format:a.ext||"vtt",isAutoGenerated:t.isAuto})}return this.createSuccess({id:r.id||Date.now().toString(),platform:"other",title:r.title||"未知标题",description:r.description,thumbnail:r.thumbnail||r.thumbnails?.[0]?.url||"",duration:r.duration||0,durationText:this.formatDuration(r.duration||0),author:r.uploader||r.channel||r.creator,authorAvatar:r.uploader_url,formats:a.slice(0,10),subtitles:i.length>0?i:void 0,originalUrl:t,parsedAt:Date.now()})}catch(e){console.error("[YtDlp] Error:",e);let t=e instanceof Error?e.message:"解析失败";if(t.includes("cookies"))return this.createError("该视频需要登录才能访问");if(t.includes("blocked"))return this.createError("IP 被封禁，请稍后重试");if(t.includes("not available"))return this.createError("视频不可用或已删除");return this.createError("解析失败，请检查链接是否正确")}}},R=["douyin","xiaohongshu","tiktok","instagram"],C=["youtube","douyin","xiaohongshu","tiktok","instagram"];function q(){return"u">typeof globalThis&&(void 0!==globalThis.WebSocketPair||void 0!==globalThis.EmailMessage)?(console.log("[Parser] Using BtchEdgeParser for Edge environment"),D):$}function _(t){return R.includes(t)}let j=new class extends k{platform="other";name="通用解析器";async parse(t){try{let e;console.log("[Generic] Parsing:",t);let r=await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}});if(!r.ok)return this.createError(`无法访问页面 (${r.status})`);let a=await r.text();if(console.log("[Generic] HTML length:",a.length),a.includes("Cloudflare")&&(a.includes("been blocked")||a.includes("Attention Required")))return this.createError("该网站有 Cloudflare 保护，服务端无法访问。请使用浏览器插件在页面上嗅探视频链接，或尝试其他下载工具");let o=a.match(/<title[^>]*>([^<]+)<\/title>/i),i=o?o[1].trim().replace(/\s*[-|].*$/,""):"未知标题",s=[],n=new Set,l=a.replace(/\\\//g,"/"),u=/(https?:\/\/[^"'\s]+\.m3u8[^"'\s]*)/gi;for(;null!==(e=u.exec(l));){let t=e[1];t=t.replace(/[",']+$/,""),n.has(t)||(n.add(t),console.log("[Generic] Found m3u8:",t.substring(0,80)),s.push(this.createFormat({id:`m3u8-${s.length}`,quality:"HLS",format:"m3u8",url:t,hasAudio:!0,hasVideo:!0})))}let d=/(https?:\/\/[^"'\s]+\.mp4[^"'\s]*)/gi;for(;null!==(e=d.exec(l));){let t=e[1];t=t.replace(/[",']+$/,""),n.has(t)||(n.add(t),console.log("[Generic] Found mp4:",t.substring(0,80)),s.push(this.createFormat({id:`mp4-${s.length}`,quality:"MP4",format:"mp4",url:t,hasAudio:!0,hasVideo:!0})))}let c="",h=a.match(/<meta[^>]*property="og:image"[^>]*content="([^"]+)"/i);if(h&&(c=h[1]),!c){let t=a.match(/<meta[^>]*name="twitter:image"[^>]*content="([^"]+)"/i);t&&(c=t[1])}if(!c)for(let t of a.matchAll(/<img[^>]+src=["']([^"']+)["']/gi)){let e=t[1];if(!(e.includes("logo")||e.includes("icon")||e.includes("avatar")||e.includes("loading")||e.startsWith("data:")||e.endsWith(".svg"))&&(e.includes("upload")||e.includes("pic")||e.includes("image"))){c=e;break}}if(!c){let t=a.match(/data-(?:src|original|xkrkllgl)=["']([^"']+\.(?:jpg|jpeg|png|webp))["']/i);t&&(c=t[1])}if(console.log("[Generic] Thumbnail:",c),0===s.length)return this.createError("未在页面中找到视频链接");return console.log("[Generic] Found",s.length,"video(s)"),this.createSuccess({id:`generic-${Date.now()}`,platform:"other",title:i,thumbnail:c,duration:0,durationText:"",formats:s,originalUrl:t,parsedAt:Date.now()})}catch(t){return console.error("[Generic] Error:",t),this.createError("解析失败，请检查链接是否正确")}}};async function I(t){try{var e;let{url:r}=await t.json();if(!r)return w.NextResponse.json({success:!1,error:"请输入视频链接"},{status:400});if((e=(e=r).trim()).startsWith("http://")||e.startsWith("https://")||(e="https://"+e),r=e,!function(t){try{let e=new URL(t);return["http:","https:"].includes(e.protocol)}catch{return!1}}(r))return w.NextResponse.json({success:!1,error:"不支持此链接，请检查是否为有效的视频链接"},{status:400});let a=function(t){try{let e=new URL(t).hostname.toLowerCase();for(let[t,r]of Object.entries(b.PLATFORMS))if(r.domains.some(t=>e===t||e.endsWith("."+t)))return t;return"unknown"}catch{return"unknown"}}(r),o=U[a]||null;if(!o){console.log(`[Parse] 未知平台，尝试通用解析: ${r}`);let t=await j.parse(r);if(t.success&&t.data)return t.data.platform="other",w.NextResponse.json({success:!0,data:t.data});console.log(`[Parse] 通用解析失败，尝试 yt-dlp: ${r}`);let e=await P.parse(r);if(e.success&&e.data)return e.data.platform="other",w.NextResponse.json({success:!0,data:e.data});return w.NextResponse.json({success:!1,error:"无法解析此链接，请确认是否为视频页面"},{status:400})}let i=await o.parse(r);if(!i.success&&"youtube"===a){console.log(`[Parse] YouTube 解析失败，尝试 FFmpeg API`);try{let t=process.env.FFMPEG_API_URL||"https://ffmpeg.226022.xyz",e=await fetch(`${t}/parse`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:r})});if(e.ok){let t=await e.json();t.success&&t.data&&(console.log(`[Parse] FFmpeg API 解析成功`),t.data.platform="youtube",i={success:!0,data:t.data})}}catch(t){console.log("[Parse] FFmpeg API 解析失败:",t)}}if(!i.success){console.log(`[Parse] 专用解析器失败，尝试通用网页解析: ${r}`);let t=await j.parse(r);if(t.success&&t.data){if(console.log(`[Parse] 通用网页解析成功, platform=${a}, hasBtchFallback=${_(a)}`),t.data.platform=a,"unknown"!==a&&_(a)){console.log(`[Parse] 尝试 btch-downloader 获取元数据`);try{let e=q(),a=await e.parse(r);console.log("[Parse] btch result:",a.success,JSON.stringify(a.data||{})),a.success&&a.data&&(a.data.thumbnail&&(t.data.thumbnail=a.data.thumbnail),a.data.title&&"未知标题"!==a.data.title&&(t.data.title=a.data.title),a.data.author&&(t.data.author=a.data.author),a.data.duration&&(t.data.duration=a.data.duration,t.data.durationText=a.data.durationText),console.log(`[Parse] 合并后: platform=${t.data.platform}, thumbnail=${t.data.thumbnail}`))}catch(t){console.log("[Parse] btch-downloader 元数据获取失败:",t)}}i=t}}if(!i.success&&_(a)){console.log(`[Parse] 尝试 btch-downloader 后备: ${r}`);try{let t=q(),e=await t.parse(r);e.success&&e.data&&(console.log(`[Parse] btch-downloader 后备解析成功`),e.data.platform=a,i=e)}catch(t){console.log("[Parse] btch-downloader 后备解析失败:",t)}}if(!i.success&&C.includes(a)){console.log(`[Parse] 尝试 yt-dlp 后备: ${r}`);try{let t=await P.parse(r);t.success&&t.data&&(console.log(`[Parse] yt-dlp 后备解析成功`),"unknown"!==a?t.data.platform=a:t.data.platform="other",i=t)}catch(t){console.log("[Parse] yt-dlp 后备解析失败:",t)}}if(!i.success){console.log(`[Parse] 尝试 FFmpeg API 后备: ${r}`);try{let t=process.env.FFMPEG_API_URL||"https://ffmpeg.226022.xyz",e=await fetch(`${t}/parse`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:r})});if(e.ok){let t=await e.json();t.success&&t.data&&(console.log(`[Parse] FFmpeg API 后备解析成功`),"unknown"!==a?t.data.platform=a:t.data.platform=t.data.platform||"other",i={success:!0,data:t.data})}}catch(t){console.log("[Parse] FFmpeg API 后备解析失败:",t)}}if(!i.success)return w.NextResponse.json({success:!1,error:i.error||"解析失败"},{status:400});if(i.success&&i.data&&"youtube"===i.data.platform&&!i.data.subtitles?.length)try{let t=r.match(/[?&]v=([a-zA-Z0-9_-]{11})/)?.[1]||r.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/)?.[1];if(t){console.log(`[Parse] 补充获取 YouTube 字幕: ${t}`);let e=new AbortController,r=setTimeout(()=>e.abort(),1e4),a=await fetch("https://www.youtube.com/youtubei/v1/player?key=AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:t,context:{client:{clientName:"ANDROID",clientVersion:"19.09.37",androidSdkVersion:30,hl:"en",gl:"US"}}}),signal:e.signal});clearTimeout(r);let o=await a.json(),s=o.captions?.playerCaptionsTracklistRenderer,n=s?.captionTracks||[],l=s?.translationLanguages||[];if(n.length>0){let t=[];for(let e of n){if(!e.baseUrl)continue;let r=e.baseUrl.includes("fmt=")?e.baseUrl.replace(/fmt=[^&]+/,"fmt=srv1"):`${e.baseUrl}&fmt=srv1`;t.push({lang:e.languageCode||"unknown",label:e.name?.simpleText||e.name?.runs?.[0]?.text||e.languageCode||"未知",url:r,format:"srt",isAutoGenerated:"asr"===e.kind})}if(l.length>0&&n.length>0){let e=n.find(t=>"asr"!==t.kind)||n[0];if(e?.baseUrl){let r=new Set(t.map(t=>t.lang));for(let a of l){let o=a.languageCode;if(!o||r.has(o))continue;let i=e.baseUrl.includes("fmt=")?e.baseUrl.replace(/fmt=[^&]+/,"fmt=srv1")+`&tlang=${o}`:`${e.baseUrl}&fmt=srv1&tlang=${o}`;t.push({lang:o,label:a.languageName?.simpleText||a.languageName?.runs?.[0]?.text||o,url:i,format:"srt",isAutoGenerated:!0})}}}i.data.subtitles=t,console.log(`[Parse] 字幕补充成功: ${t.length} 条`)}}}catch(t){console.log("[Parse] 字幕补充失败（不影响视频解析）:",t instanceof Error?t.message:t)}return w.NextResponse.json({success:!0,data:i.data})}catch(t){return console.error("Parse error:",t),w.NextResponse.json({success:!1,error:t instanceof Error?t.message:"服务器错误"},{status:500})}}t.s(["POST",()=>I],77526);var F=t.i(77526);let O=new e.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/parse/route",pathname:"/api/parse",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/parse/route.ts",nextConfigOutput:"standalone",userland:F}),{workAsyncStorage:N,workUnitAsyncStorage:V,serverHooks:H}=O;function M(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:V})}async function W(t,e,a){O.isDev&&(0,o.addRequestMeta)(t,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/parse/route";w=w.replace(/\/index$/,"")||"/";let b=await O.prepare(t,e,{srcPage:w,multiZoneDraftMode:!1});if(!b)return e.statusCode=400,e.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:k,nextConfig:A,parsedUrl:x,isDraftMode:T,prerenderManifest:E,routerServerContext:S,isOnDemandRevalidate:U,revalidateOnlyGenerated:$,resolvedPathname:D,clientReferenceManifest:P,serverActionsManifest:R}=b,C=(0,n.normalizeAppPath)(w),q=!!(E.dynamicRoutes[C]||E.routes[D]),_=async()=>((null==S?void 0:S.render404)?await S.render404(t,e,x,!1):e.end("This page could not be found"),null);if(q&&!T){let t=!!E.routes[D],e=E.dynamicRoutes[C];if(e&&!1===e.fallback&&!t){if(A.experimental.adapterPath)return await _();throw new g.NoFallbackError}}let j=null;!q||O.isDev||T||(j="/index"===(j=D)?"/":j);let I=!0===O.isDev||!q,F=q&&!I;R&&P&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:P,serverActionsManifest:R});let N=t.method||"GET",V=(0,i.getTracer)(),H=V.getActiveScopeSpan(),M={params:k,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,o.getRequestMeta)(t,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:t=>{e.on("close",t)},onAfterTaskError:void 0,onInstrumentationRequestError:(e,r,a,o)=>O.onRequestError(t,e,a,o,S)},sharedContext:{buildId:v}},W=new l.NodeNextRequest(t),L=new l.NodeNextResponse(e),z=u.NextRequestAdapter.fromNodeNextRequest(W,(0,u.signalFromNodeResponse)(e));try{let s=async t=>O.handle(z,M).finally(()=>{if(!t)return;t.setAttributes({"http.status_code":e.statusCode,"next.rsc":!1});let r=V.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let e=`${N} ${a}`;t.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),t.updateName(e)}else t.updateName(`${N} ${w}`)}),n=!!(0,o.getRequestMeta)(t,"minimalMode"),l=async o=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!n&&U&&$&&!r)return e.statusCode=404,e.setHeader("x-nextjs-cache","REVALIDATED"),e.end("This page could not be found"),null;let i=await s(o);t.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=M.renderOpts.collectedTags;if(!q)return await (0,h.sendResponse)(W,L,i,M.renderOpts.pendingWaitUntil),null;{let t=await i.blob(),e=(0,p.toNodeOutgoingHttpHeaders)(i.headers);u&&(e[f.NEXT_CACHE_TAGS_HEADER]=u),!e["content-type"]&&t.type&&(e["content-type"]=t.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,a=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await t.arrayBuffer()),headers:e},cacheControl:{revalidate:r,expire:a}}}}catch(e){throw(null==r?void 0:r.isStale)&&await O.onRequestError(t,e,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:U})},!1,S),e}},d=await O.handleResponse({req:t,nextConfig:A,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:U,revalidateOnlyGenerated:$,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:n});if(!q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||e.setHeader("x-nextjs-cache",U?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),T&&e.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,p.fromNodeOutgoingHttpHeaders)(d.value.headers);return n&&q||g.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||e.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(W,L,new Response(d.value.body,{headers:g,status:d.value.status||200})),null};H?await l(H):await V.withPropagatedContext(t.headers,()=>V.trace(d.BaseServerSpan.handleRequest,{spanName:`${N} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":N,"http.target":t.url}},l))}catch(e){if(e instanceof g.NoFallbackError||await O.onRequestError(t,e,{routerKind:"App Router",routePath:C,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:U})},!1,S),q)throw e;return await (0,h.sendResponse)(W,L,new Response(null,{status:500})),null}}t.s(["handler",()=>W,"patchFetch",()=>M,"routeModule",()=>O,"serverHooks",()=>H,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>V],66863)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__9cf6b518._.js.map